#include <cpu/ifetch.h>
#include <isa-all-instr.h>

#include "../local-include/reg.h"

def_all_THelper();

// static uint32_t get_instr(Decode *s) __attribute__((optimize("O0")));
// static uint32_t get_instr(Decode *s) { return s->isa.instr.val; }
// static uint32_t get_instr(Decode *s) {
//   volatile uint32_t val;
//   val = s->isa.instr.val;
//   return val;
// }
// inline uint32_t get_instr(Decode *s) { return s->isa.instr.val; }
#define get_instr(ds) ((uint32_t)(ds->isa.instr.val))

// decode operand helper
#define def_DopHelper(name) \
  void concat(decode_op_, name)(Decode * s, Operand * op, word_t val, bool flag)

/**
 * @brief 取立即数到op->imm
 * @param val: 值
 */
def_DopHelper(i) {
  op->imm = val;
  // print_Dop(op->str, OP_STR_SIZE, (flag ? "0x%x" : "%d"), op->imm);
}

/**
 * @brief 取寄存器操作信息
 * @param val: 寄存器号
 * @param flag: 是否写入（regWrite）
 */
def_DopHelper(r) {
  static bool is_write;
  is_write = flag;
  // x0寄存器
  static word_t zero_null = 0;
  // always zero!!!
  zero_null = 0;
  op->preg = (is_write && val == 0) ? &zero_null : &gpr(val);
  // print_Dop(op->str, OP_STR_SIZE, "%s", reg_name(val, 4));
}

def_DHelper(I) {
  decode_op_r(s, id_src1, s->isa.instr.i.rs1, false);
  decode_op_i(s, id_src2, imm_sext32(s->isa.instr.i.simm11_0, 12), false);
  decode_op_r(s, id_dest, s->isa.instr.i.rd, true);
}

def_DHelper(U) {
  // decode_op_i(s, id_src1, imm_sext32(s->isa.instr.u.imm31_12 << 12, 20),
  // true);
  decode_op_i(s, id_src1, imm_sext32(s->isa.instr.u.imm31_12, 20) << 12, true);
  decode_op_r(s, id_dest, s->isa.instr.u.rd, true);
}

def_DHelper(S) {
  decode_op_r(s, id_src1, s->isa.instr.s.rs1, false);
  sword_t simm =
      imm_sext32((s->isa.instr.s.simm11_5 << 5) | s->isa.instr.s.imm4_0, 12);
  decode_op_i(s, id_src2, simm, false);
  decode_op_r(s, id_dest, s->isa.instr.s.rs2, true);
}

def_DHelper(R) {
  decode_op_r(s, id_src1, s->isa.instr.r.rs1, false);
  decode_op_r(s, id_src2, s->isa.instr.r.rs2, false);
  decode_op_r(s, id_dest, s->isa.instr.r.rd, true);
}

def_DHelper(B) {
  decode_op_r(s, id_src1, s->isa.instr.b.rs1, false);
  sword_t simm = imm_sext32(
      (s->isa.instr.b.simm12 << 12) | (s->isa.instr.b.imm11 << 11) |
          (s->isa.instr.b.imm10_5 << 5) | (s->isa.instr.b.imm4_1 << 1),
      13);
  decode_op_i(s, id_src2, simm, false);
  decode_op_r(s, id_dest, s->isa.instr.b.rs2, false);
}

def_DHelper(J) {
  sword_t simm = imm_sext32(
      (s->isa.instr.j.simm20 << 20) | (s->isa.instr.j.imm19_12 << 12) |
          (s->isa.instr.j.imm11 << 11) | (s->isa.instr.j.imm10_1 << 1),
      21);
  decode_op_i(s, id_src2, simm, false);
  decode_op_r(s, id_dest, s->isa.instr.j.rd, true);
}

#define MY_MUXDEF(def, a, b) \
  do {                       \
    if (MUXDEF(def, 1, 0)) { \
      a;                     \
    } else {                 \
      b;                     \
    }                        \
  } while (0)

def_THelper(load) {
  // Log("inst: " FMT_WORD ", fun: " FMT_WORD ", fc: " FMT_WORD, get_instr(s),
  // ((get_instr(s) >> 12) & (0x7)), ((get_instr(s) >> 25) & (0xfe >> 1)));
  // Log("inst: " FMT_WORD ", fun: " FMT_WORD ", fc: " FMT_WORD, get_instr(s),
  // ((get_instr(s) >> 12) & (0x7)), ((get_instr(s) >> 25) & (0xfe >> 1)));
  // Log("inst: " FMT_WORD ", fun: " FMT_WORD ", fc: " FMT_WORD, get_instr(s),
  // ((get_instr(s) >> 12) & (0x7)), ((get_instr(s) >> 25) & (0xfe >> 1)));
  MY_MUXDEF(
      CONFIG_EXT_DECODE_OPTIM,
      {
        // Log("lw");
        def_INSTR_IDTAB_Function(0x2, lw);
        // Log("lb");
        def_INSTR_IDTAB_Function(0x0, lb);
        // Log("lh");
        def_INSTR_IDTAB_Function(0x1, lh);
        def_INSTR_IDTAB_Function(0x4, lbu);
        def_INSTR_IDTAB_Function(0x5, lhu);
      },
      {
        def_INSTR_TAB("??????? ????? ????? 010 ????? ????? ??", lw);
        def_INSTR_TAB("??????? ????? ????? 000 ????? ????? ??", lb);
        def_INSTR_TAB("??????? ????? ????? 001 ????? ????? ??", lh);
        def_INSTR_TAB("??????? ????? ????? 100 ????? ????? ??", lbu);
        def_INSTR_TAB("??????? ????? ????? 101 ????? ????? ??", lhu);
      });

  return EXEC_ID_inv;
}

def_THelper(store) {
  MY_MUXDEF(
      CONFIG_EXT_DECODE_OPTIM,
      {
        def_INSTR_IDTAB_Function(0x2, sw);
        def_INSTR_IDTAB_Function(0x0, sb);
        def_INSTR_IDTAB_Function(0x1, sh);
      },
      {
        def_INSTR_TAB("??????? ????? ????? 010 ????? ????? ??", sw);
        def_INSTR_TAB("??????? ????? ????? 000 ????? ????? ??", sb);
        def_INSTR_TAB("??????? ????? ????? 001 ????? ????? ??", sh);
      });
  return EXEC_ID_inv;
}

def_THelper(calc) {
  MY_MUXDEF(
      CONFIG_EXT_DECODE_OPTIM,
      {
        // Log("inst: " FMT_WORD ", fun: " FMT_WORD ", fc: " FMT_WORD,
        //     get_instr(s), ((get_instr(s) >> 12)), ((get_instr(s) >> 25)));
        // Log("inst: " FMT_WORD ", fun: " FMT_WORD ", fc: " FMT_WORD,
        //     get_instr(s), ((get_instr(s) >> 12) & 0x7),
        //     ((get_instr(s) >> 25) & (0xfe >> 1)));
        def_INSTR_IDTAB_Function2(0x0, 0x00, add);
        def_INSTR_IDTAB_Function2(0x0, 0x20, sub);
        def_INSTR_IDTAB_Function2(0x1, 0x00, sll);
        def_INSTR_IDTAB_Function2(0x2, 0x00, slt);
        def_INSTR_IDTAB_Function2(0x3, 0x00, sltu);
        def_INSTR_IDTAB_Function2(0x4, 0x00, xor);
        def_INSTR_IDTAB_Function2(0x5, 0x00, srl);
        def_INSTR_IDTAB_Function2(0x5, 0x20, sra);
        def_INSTR_IDTAB_Function2(0x6, 0x00, or);
        def_INSTR_IDTAB_Function2(0x7, 0x00, and);

        def_INSTR_IDTAB_Function2(0x0, 0x01, mul);
        def_INSTR_IDTAB_Function2(0x1, 0x01, mulh);
        def_INSTR_IDTAB_Function2(0x2, 0x01, mulhsu);
        def_INSTR_IDTAB_Function2(0x3, 0x01, mulhu);
        def_INSTR_IDTAB_Function2(0x4, 0x01, div);
        def_INSTR_IDTAB_Function2(0x5, 0x01, divu);
        def_INSTR_IDTAB_Function2(0x6, 0x01, rem);
        def_INSTR_IDTAB_Function2(0x7, 0x01, remu);
      },
      {
        def_INSTR_TAB("0000000 ????? ????? 000 ????? ????? ??", add);
        def_INSTR_TAB("0100000 ????? ????? 000 ????? ????? ??", sub);
        def_INSTR_TAB("0000000 ????? ????? 001 ????? ????? ??", sll);
        def_INSTR_TAB("0000000 ????? ????? 010 ????? ????? ??", slt);
        def_INSTR_TAB("0000000 ????? ????? 011 ????? ????? ??", sltu);
        def_INSTR_TAB("0000000 ????? ????? 100 ????? ????? ??", xor);
        def_INSTR_TAB("0000000 ????? ????? 101 ????? ????? ??", srl);
        def_INSTR_TAB("0100000 ????? ????? 101 ????? ????? ??", sra);
        def_INSTR_TAB("0000000 ????? ????? 110 ????? ????? ??", or);
        def_INSTR_TAB("0000000 ????? ????? 111 ????? ????? ??", and);
        // RV32M Parts
        def_INSTR_TAB("0000001 ????? ????? 000 ????? ????? ??", mul);
        def_INSTR_TAB("0000001 ????? ????? 001 ????? ????? ??", mulh);
        def_INSTR_TAB("0000001 ????? ????? 010 ????? ????? ??", mulhsu);
        def_INSTR_TAB("0000001 ????? ????? 011 ????? ????? ??", mulhu);
        def_INSTR_TAB("0000001 ????? ????? 100 ????? ????? ??", div);
        def_INSTR_TAB("0000001 ????? ????? 101 ????? ????? ??", divu);
        def_INSTR_TAB("0000001 ????? ????? 110 ????? ????? ??", rem);
        def_INSTR_TAB("0000001 ????? ????? 111 ????? ????? ??", remu);
      });

  return EXEC_ID_inv;
}

def_THelper(calci) {
  MY_MUXDEF(
      CONFIG_EXT_DECODE_OPTIM,
      {
        def_INSTR_IDTAB_Function(0x0, addi);
        def_INSTR_IDTAB_Function_fc(0x1, 0x00, slli);
        def_INSTR_IDTAB_Function(0x2, slti);
        def_INSTR_IDTAB_Function(0x3, sltiu);
        def_INSTR_IDTAB_Function(0x4, xori);
        def_INSTR_IDTAB_Function_fc(0x5, 0x00, srli);
        def_INSTR_IDTAB_Function_fc(0x5, 0x20, srai);
        def_INSTR_IDTAB_Function(0x6, ori);
        def_INSTR_IDTAB_Function(0x7, andi);
      },
      {
        def_INSTR_TAB("??????? ????? ????? 000 ????? ????? ??", addi);
        def_INSTR_TAB("000000? ????? ????? 001 ????? ????? ??", slli);
        def_INSTR_TAB("??????? ????? ????? 010 ????? ????? ??", slti);
        def_INSTR_TAB("??????? ????? ????? 011 ????? ????? ??", sltiu);
        def_INSTR_TAB("??????? ????? ????? 100 ????? ????? ??", xori);
        def_INSTR_TAB("000000? ????? ????? 101 ????? ????? ??", srli);
        def_INSTR_TAB("010000? ????? ????? 101 ????? ????? ??", srai);
        def_INSTR_TAB("??????? ????? ????? 110 ????? ????? ??", ori);
        def_INSTR_TAB("??????? ????? ????? 111 ????? ????? ??", andi);
      });

  return EXEC_ID_inv;
}

def_THelper(branches) {
  MY_MUXDEF(
      CONFIG_EXT_DECODE_OPTIM,
      {
        def_INSTR_IDTAB_Function(0x0, beq);
        def_INSTR_IDTAB_Function(0x1, bne);
        def_INSTR_IDTAB_Function(0x4, blt);
        def_INSTR_IDTAB_Function(0x5, bge);
        def_INSTR_IDTAB_Function(0x6, bltu);
        def_INSTR_IDTAB_Function(0x7, bgeu);
      },
      {
        def_INSTR_TAB("??????? ????? ????? 000 ????? ????? ??", beq);
        def_INSTR_TAB("??????? ????? ????? 001 ????? ????? ??", bne);
        def_INSTR_TAB("??????? ????? ????? 100 ????? ????? ??", blt);
        def_INSTR_TAB("??????? ????? ????? 101 ????? ????? ??", bge);
        def_INSTR_TAB("??????? ????? ????? 110 ????? ????? ??", bltu);
        def_INSTR_TAB("??????? ????? ????? 111 ????? ????? ??", bgeu);
      });

  return EXEC_ID_inv;
}

def_THelper(sys) {
  def_INSTR_TAB("??????? ????? ????? 001 ????? ????? ??", csrrw);
  def_INSTR_TAB("??????? ????? ????? 010 ????? ????? ??", csrrs);
  def_INSTR_TAB("??????? ????? ????? 011 ????? ????? ??", csrrc);
  def_INSTR_TAB("??????? ????? ????? 101 ????? ????? ??", csrrwi);
  def_INSTR_TAB("??????? ????? ????? 110 ????? ????? ??", csrrsi);
  def_INSTR_TAB("??????? ????? ????? 111 ????? ????? ??", csrrci);
  def_INSTR_TAB("0000000 00001 00000 000 00000 ????? ??", ebreak);
  def_INSTR_TAB("0001000 00101 00000 000 00000 ????? ??", wfi);
  def_INSTR_TAB("0000000 00000 00000 000 00000 ????? ??", ecall);
  def_INSTR_TAB("0011000 00010 00000 000 00000 ????? ??", mret);
  return EXEC_ID_inv;
}

def_THelper(amo) {
  def_INSTR_TAB("00000?? ????? ????? 010 ????? ????? ??", amoadd);
  def_INSTR_TAB("01100?? ????? ????? 010 ????? ????? ??", amoand);
  def_INSTR_TAB("10100?? ????? ????? 010 ????? ????? ??", amomax);
  def_INSTR_TAB("11100?? ????? ????? 010 ????? ????? ??", amomaxu);
  def_INSTR_TAB("10000?? ????? ????? 010 ????? ????? ??", amomin);
  def_INSTR_TAB("11000?? ????? ????? 010 ????? ????? ??", amominu);
  def_INSTR_TAB("01000?? ????? ????? 010 ????? ????? ??", amoor);
  def_INSTR_TAB("00001?? ????? ????? 010 ????? ????? ??", amoswap);
  def_INSTR_TAB("00100?? ????? ????? 010 ????? ????? ??", amoxor);
  def_INSTR_TAB("00010?? ????? ????? 010 ????? ????? ??", lr);
  def_INSTR_TAB("00011?? ????? ????? 010 ????? ????? ??", sc);
  return EXEC_ID_inv;
}

def_THelper(main) {
  MY_MUXDEF(
      CONFIG_EXT_DECODE_OPTIM,
      {
        def_INSTR_IDTAB_Header(0x03, I, load);
        def_INSTR_IDTAB_Header(0x23, S, store);
        def_INSTR_IDTAB_Header(0x37, U, lui);
        def_INSTR_IDTAB_Header(0x33, R, calc);
        def_INSTR_IDTAB_Header(0x13, I, calci);
        def_INSTR_IDTAB_Header(0x73, I, sys);
        def_INSTR_IDTAB_Header(0x6f, J, jal);
        def_INSTR_IDTAB_Header(0x67, I, jalr);
        def_INSTR_IDTAB_Header(0x17, U, auipc);
        def_INSTR_IDTAB_Header(0x63, B, branches);
        def_INSTR_IDTAB_Header(0x2f, R, amo);
      },
      {
        def_INSTR_IDTAB("??????? ????? ????? ??? ????? 00000 11", I, load);
        def_INSTR_IDTAB("??????? ????? ????? ??? ????? 01000 11", S, store);
        def_INSTR_IDTAB("??????? ????? ????? ??? ????? 01101 11", U, lui);
        def_INSTR_IDTAB("??????? ????? ????? ??? ????? 01100 11", R, calc);
        def_INSTR_IDTAB("??????? ????? ????? ??? ????? 00100 11", I, calci);

        def_INSTR_IDTAB("??????? ????? ????? ??? ????? 11100 11", I, sys);

        def_INSTR_IDTAB("??????? ????? ????? ??? ????? 11011 11", J, jal);
        def_INSTR_IDTAB("??????? ????? ????? ??? ????? 11001 11", I, jalr);

        def_INSTR_IDTAB("??????? ????? ????? ??? ????? 00101 11", U, auipc);

        def_INSTR_IDTAB("??????? ????? ????? ??? ????? 11000 11", B, branches);

        def_INSTR_IDTAB("??????? ????? ????? ??? ????? 01011 11", R, amo);
      });

  def_INSTR_TAB("000???? ????0 00000 000 00000 00011 11", fence);

  def_INSTR_TAB("??????? ????? ????? ??? ????? 11010 11", nemu_trap);

  return table_inv(s);
};

/**
 * @brief 取指函数
 *
 * @param s
 * @return int g_exec_table[]的索引，指向需要执行的函数
 */
int isa_fetch_decode(Decode *s) {
  s->isa.instr.val = instr_fetch(&s->snpc, 4);
  int idx = table_main(s);
  return idx;
}
